#!/bin/bash

save () {
	echo "Saving the Ehrhart polynomial file and the LattE file that generated it."
	tag=`date | tr -d [\ :]`
	cp ehrhart.txt savedfiles/ehrhart.$tag$2
	cp $1 savedfiles/latte.$tag$2
	clean
}

clean () {
	rm -f input.txt commands.txt ans.txt ehrhart.txt
}

if [[ $1 =~ options ]]
then
	echo "-r: calculates the roots of the ehrhart polynomial and appends it to the automatically generated ehrhart file"
	echo "-s: saves the ehrhart and latte files if a coefficient of the ehrhart polynomial is negative"
	echo "-R: invokes the -r option and saves the latte abd ehrhart files if the real part of a root is positive"
	echo "-S: forces a save of the ehrhart and latte files"
	exit 0
fi

if [[ $# -lt 2 ]]
then
	echo "Usage: ehrhart2 dim file [options]"
	echo "Type ehrhart2 -options for option descriptions"
	exit 0
fi

root=0
save=0
rootsave=0
forcesave=0

if [[ $# -gt 2 ]]
then
	if [[ $3 =~ r ]]
	then
		root=1
	fi
	if [[ $3 =~ R ]]
	then
		root=1
		rootsave=1
	fi
	if [[ $3 =~ s ]]
	then
		save=1
	fi
	if [[ $3 =~ S ]]
	then
		forcesave=1
	fi
fi

echo $1 > input.txt
./ehrhart $1 $2 2> /dev/null | cut -dt -f1 >> input.txt
if [ $? -eq 0 ]
then
	./ehrhart3 < input.txt > ehrhart.txt
else
	echo "problem in ehrhart (probably a segfault or interrupt)"
	rm -f input.txt
	exit 0
fi

if [[ $root -eq 1 ]]
then
	echo -n "p = sym('" > commands.txt
	#head -1 ehrhart.txt | tr -d [*+^] | sed -e s/t[0-9]*//g >> commands.txt
	head -1 ehrhart.txt  | sed s/\$/\'\)\;/g  >> commands.txt
	echo "syms t;" >> commands.txt
	echo "fptr = fopen('ehrhart.matlabroots.txt', 'w'); %will delete old data; maybe use 'a'?" >> commands.txt
	echo "theRoots = solve(p);" >> commands.txt
	echo "" >> commands.txt
	echo "for i = 1:length(theRoots)" >> commands.txt
	echo "	if imag(theRoots(i)) ~= 0" >> commands.txt
	echo "     fprintf(fptr, '%f  %fi => %f\n', double(real(theRoots(i))), double(imag(theRoots(i))), double(subs(p, t, theRoots(i))));" >> commands.txt
	echo "  else" >> commands.txt
	echo "     fprintf(fptr, '%f => %f\n', double(theRoots(i)), double(subs(p, t, theRoots(i))));" >> commands.txt
	echo "  end% if complex number"  >> commands.txt
	echo "end%for i" >> commands.txt
	echo "" >> commands.txt
	echo "fclose(fptr);" >> commands.txt
	echo "save ans.txt ans -ascii" >> commands.txt
	echo "exit" >> commands.txt
	matlab < commands.txt > /dev/null
	cat ehrhart.matlabroots.txt >> ehrhart.txt


	#now in maple
	echo "Digits:=1000;" > commands.txt
	echo -n "p :=" >> commands.txt
	head -1 ehrhart.txt >> commands.txt
	echo ":" >> commands.txt
	echo "ans := fsolve(p = 0, t, complex):" >> commands.txt
	echo "for x in ans do printf(\"%f =\> %f\\n\", x, subs(t = x, p)); od;" >> commands.txt


	cat commands.txt
	echo "************" >> ehrhart.txt
	echo "Now in maple" >> ehrhart.txt


	maple < commands.txt >> ehrhart.txt
	
fi

cat ehrhart.txt 

if [[ forcesave -eq 1 ]]
then
	save $2 S
fi

if [[ save -eq 1 ]]
then
	if [[ `head -1 ehrhart.txt | grep /-/` != "" ]]
	then
		save $2 s
	fi
fi

#if [[ rootsave -eq 1 ]]
#then
#	then
#		save $2 r
#	fi
#fi

#clean
# when saving, the file gets appended with the date (sans spaces and colons) and the option which caused the save
# S > s > R is the precedence of option tags (a forced save overrides all and, arbitrarily, having a negative
# coefficient in the Ehrhart polynomial is more important than having a positive real part of a root






